<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta charset="utf-8">
    <script src="https://unpkg.com/ipfs-api@9.0.0/dist/index.js" integrity="sha384-5bXRcW9kyxxnSMbOoHzraqa7Z0PQWIao+cgeg327zit1hz5LZCEbIMx/LWKPReuB" crossorigin="anonymous">
    </script>
    <!--here put script for download -->
    <!--<script src="http://localhost:8080/ipfs/QmYYgozRqMh9puKGTrANYrkAmXUfB2vjEiswGuUniQWYnE"></script>
    <link rel="stylesheet" href="http://localhost:8080/ipfs/QmbxmLuNJ8WKzQ3ScCThwkn2vMsE9jqyULf9ij2gE6VKmJ">
    -->
    <link href="//cdn.muicss.com/mui-0.9.36/css/mui.min.css" rel="stylesheet" type="text/css" />
    <script src="//cdn.muicss.com/mui-0.9.36/js/mui.min.js"></script>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.2.0/dropzone.js" integrity="sha256-MYkm5duNIZ3hSUNlCZbGQziNmlfMcDXOrz9uM48LMQg=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.2.0/dropzone.css" integrity="sha256-0Z6mOrdLEtgqvj7tidYQnCYWG3G2GAIpatAWKhDx+VM=" crossorigin="anonymous" />
    
    <script>
        var ipfs = window.IpfsApi({
            host: '127.0.0.1',
            port: '5001',
            protocol: 'http'
        })
    </script>
    <script>
        function handle(e) {
            console.log(e.target.id);
            fetch('http://localhost:5001/api/v0/cat?arg=' + e.target.id).then(function(response) {
                console.log(response);
                return response.blob();
            }).then(function(myBlob) {
                console.log('my', myBlob);
                let reader = new FileReader();
                reader.onload = (data) => {
                    //console.log(data.target.result);
                    var img = document.createElement('img');
                    const div = document.getElementById('imageDiv');
                    img.src = 'data:image/jpeg;base64,' + data.target.result;
                    img.height = 200;
                    img.width = 300;
                    div.appendChild(img);
                }
                reader.readAsBinaryString(myBlob);
            });
        }
        //Функция самой отправки данных
        function test(data) {
            const tb = document.getElementById('tbody');
            let img = window.btoa(data.body);
            //console.log(data);
            const files = [{
                path: data.name,
                content: img
            }]

            ipfs.files.add(files, function(err, file) {
                if (err) console.log(err);
                else {
                    console.log(file);
                    for (let i = 0; i < file.length; i++) {
                        let tr = document.createElement('tr');
                        tr.className = ' ' + file[i].hash + ' ';
                        let td1 = document.createElement('td');
                        td1.innerHTML = file.path;
                        let td2 = document.createElement('td');
                        td2.id = file[i].hash;
                        td2.onclick = handle;
                        td2.innerHTML = file[i].hash;
                        tr.appendChild(td1);
                        tr.appendChild(td2);
                        tb.appendChild(tr);
                    }
                }
            })

        }
    </script>

    
   
</head>

<body>
    minimalism
    <div>
        <input type="file" id="test" onchange="handleFiles(this.files)" multiple placeholder="Загрузить">
    </div>
    <div>
        <ul id="resultUl">
            Нажми на хэш
        </ul>

    </div>
    <!--
    <div>
        <input type="file" id="fileElem" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
        <a href="#" id="fileSelect">Select some files</a> 
        <div id="fileList">
          <p>No files selected!</p>
        </div>
    </div>
    -->
    <div id="imageDiv">

    </div>
    <button id = "uploadBtn" class="mui-btn mui-btn--primary" type="button">Upload to IPFS</button>
    <form action='/'
      class="dropzone"
      id="my-awesome-dropzone">
      </form>
    <script>
        const inputElement = document.getElementById("test");
        inputElement.addEventListener("change", handleFiles, false);

        function handleFiles() {
            let fileList = this.files;
            console.log(fileList);
            for (let i = 0; i < fileList.length; i++) {
                const reader = new FileReader();
                reader.onload = function(data) {
                    //всё отправляем
                    test(data.target.result);
                };
                reader.readAsBinaryString(fileList[i]);
            }
        }
        /*function handleFiles(files) {
            if (!files.length) {
                fileList.innerHTML = "<p>No files selected!</p>";
            } else {
                fileList.innerHTML = "";
                var list = document.createElement("ul");
                fileList.appendChild(list);
                for (var i = 0; i < files.length; i++) {
                  var li = document.createElement("li");
                  list.appendChild(li);
                  
                  var img = document.createElement("img");
                  img.src = window.URL.createObjectURL(files[i]);
                  img.height = 60;
                  img.onload = function() {
                    window.URL.revokeObjectURL(this.src);
                  }
                  li.appendChild(img);
                  var info = document.createElement("span");
                  info.innerHTML = files[i].name + ": " + files[i].size + " bytes";
                  li.appendChild(info);
                }
            }
        }*/
    </script>

    <script>
        const arr1 = [];
  Dropzone.options.myAwesomeDropzone = {
      //accept file mime-type
      acceptedFiles: 'image/jpeg, image/jpg, image/png',
      autoProcessQueue: false,
      init: function() {
          this.on("addedfile", function(file) {
            //second check for mime-type
            if(file.type != 'image/jpeg' || file.type != 'image/jpg' || file.type != 'image/png') {
                
            } else this.removeFile(file);
            //entity for send to IPFS
            const obj = {
                name:'',
                body:'',
                hash:'',
            };
            //console.log(arr1);
            let fileList = file;
                console.log('до получения',arr1.length);
                const reader = new FileReader();
                reader.onload = function(data) {
                    //всё отправляем
                    // console.log(data.target.result);
                    let base64 = window.btoa(data.target.result);
                    obj.name = fileList.name;
                    obj.body = base64;
                    arr1.push(obj);
                    //console.log('после получения',arr1.length);
                };
                reader.readAsBinaryString(fileList);
            // Create the remove button
            var removeButton = Dropzone.createElement('<button class="mui-btn mui-btn--raised mui-btn--danger">Remove file</button>');
            

            // Capture the Dropzone instance as closure.
            var _this = this;

            // Listen to the click event
            removeButton.addEventListener("click", function(e) {
              // Make sure the button click doesn't submit the form:
              e.preventDefault();
              e.stopPropagation();

              // Remove the file preview.
              _this.removeFile(file);
              for(let i = 0; i < arr1.length; i++){
                file.name == arr1[i].name? arr1.splice(i,1) : '';
              }
              // If you want to the delete the file on the server as well,
              // you can do the AJAX request here.
            });

            // Add the button to the file preview element.
            file.previewElement.appendChild(removeButton);
            file.previewElement.setAttribute('class', 'dz-preview dz-processing dz-success dz-complete dz-image-preview');
            file.previewElement.setAttribute('align', 'center');
          });
        }

    };
    </script>
    <script>
        const upload = document.getElementById('uploadBtn');
        upload.onClick = (e) => {
            for (let i = 0; i < arr1.length; i++) {
                test(arr1[i]);
            }
        }
    </script>
    <table id = "table" class="mui-table">
  <thead>
    <tr>
      <th>img</th>
      <th>IPFS multihash</th>
    </tr>
  </thead>
  <tbody id="tbody">
    <tr>
      <td>Cell 1-1</td>
      <td>Cell 1-2</td>
    </tr>
    <tr>
      <td>Cell 2-1</td>
      <td>Cell 2-2</td>
    </tr>
  </tbody>
</table>
</body>

</html>