<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta charset="utf-8">
    <!-- bootstrap 4.0.0 -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Dropzone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.2.0/min/dropzone.min.js" integrity="sha256-eO9VTVeZLaplH86Iwt8l39+l7GZpLOTsVWYziS5oY0Q=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="dropzone.css" />
    <link rel="stylesheet" href="index.css" />
    <!-- sweetAlert2 -->
    <script src="https://unpkg.com/sweetalert2@7.12.15/dist/sweetalert2.all.js"></script>
    <!-- buffer -->
    <script src="https://wzrd.in/standalone/buffer"></script>
    <!-- js-ipfs-api -->
    <script src="https://unpkg.com/ipfs-api@9.0.0/dist/index.js" integrity="sha384-5bXRcW9kyxxnSMbOoHzraqa7Z0PQWIao+cgeg327zit1hz5LZCEbIMx/LWKPReuB" crossorigin="anonymous"></script>

    <script type="text/javascript">
        /* const node = new Ipfs({
                    repo: 'ipfs-' + Math.random()
                })
                node.once('ready', () => {
                   document.getElementById("status").innerHTML= 'Node status: ' + (node.isOnline() ? 'online' : 'offline');
                })*/
        var ipfs = window.IpfsApi({
            host: '91.201.41.253',
            port: '5001',
            protocol: 'http'
        });
        const host = 'http://91.201.41.253:7777/ipfs/';
    </script>


</head>

<body>
    <div class="container">
        <div class="navbar navbar-expand-lg navbar-light bg-light">
            <h1 class="text-center">GOLOS IMAGES</h1>
        </div>
        <div class="main">
            <h3 id="status" class="text-center"></h3>
            <div id="uploadDiv">
                <button id="uploadBtn" class="btn btn-primary btn-lg btn-block text-uppercase" type="button">Upload to IPFS</button>
            </div>
            <form action='/' class="dropzone form" id="my-awesome-dropzone">
            </form>
            <input id="forCopy" type ="text" />
            <table id="table" class="table" hidden="true">
                <thead>
                    <tr>
                        <th class="text-center">Preview</th>
                        <th class="text-center">IPFS multihash</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>
        <script>
            //for add to IPFS
            let arr1 = [];
            //for check table
            let arr2 = [];
            Dropzone.options.myAwesomeDropzone = {
                //accept file mime-type
                acceptedFiles: 'image/jpeg, image/jpg, image/png',
                dictDefaultMessage: "Drag&Drop files here or click to select files",
                autoProcessQueue: false,
                init: function() {
                    this.on("addedfile", function(file) {
                        //second check for mime-type
                        if (file.type != 'image/jpeg' || file.type != 'image/jpg' || file.type != 'image/png') {

                        } else this.removeFile(file);
                        //entity for send to IPFS

                        //console.log(arr1);
                        let fileList = file;
                        const reader = new FileReader();
                        reader.onload = function(data) {
                            const obj = {
                                name: '',
                                body: '',
                                hash: '',
                            };
                            //!!!!!This is for version without buffer
                            /*let base64 = window.btoa(data.target.result);
                            obj.body = base64;*/
                            obj.body = buffer.Buffer(data.target.result);
                            /* obj.body = data.target.result;*/
                            obj.name = fileList.name;
                            arr1.push(obj);
                            let uploadBtn = document.getElementById('uploadBtn');
                            uploadBtn.style.display = "block";
                        };
                        reader.readAsArrayBuffer(fileList);
                        // Create the remove button
                        var removeButton = Dropzone.createElement('<button class="btn btn-warning">Remove file</button>');
                        // Capture the Dropzone instance as closure.
                        var _this = this;
                        //remove all files
                        document.getElementById("uploadBtn").addEventListener("click", function() {
                            _this.removeAllFiles();
                            arr1 = [];
                            let uploadBtn = document.getElementById('uploadBtn');
                            uploadBtn.style.display = "none";
                        });
                        // Listen to the click event
                        removeButton.addEventListener("click", function(e) {
                            // Make sure the button click doesn't submit the form:
                            e.preventDefault();
                            e.stopPropagation();

                            // Remove the file preview.
                            _this.removeFile(file);
                            let uploadBtn = document.getElementById('uploadBtn');

                            for (let i = 0; i < arr1.length; i++) {
                                file.name == arr1[i].name ? arr1.splice(i, 1) : '';
                            }
                            arr1.length > 0 ? uploadBtn.style.display = "block" : uploadBtn.style.display = "none";
                            // If you want to the delete the file on the server as well,
                            // you can do the AJAX request here.
                        });

                        // Add the button to the file preview element.
                        file.previewElement.appendChild(removeButton);
                        file.previewElement.setAttribute('class', 'dz-preview dz-processing dz-success dz-complete dz-image-preview elementIpfs');
                        file.previewElement.setAttribute('align', 'center');
                    });
                }

            };
        </script>
        <script>
            function handle(e) {
                console.log(e.target.id);
                window.open(host + e.target.id);
            }
            function copyLink(e){
                document.getElementById('forCopy').value = host + e.target.id;
                document.querySelector('#forCopy').select();
                console.log(host);
                try {
                    document.execCommand('copy');
                  } catch (err) {
                    console.log('Links not correctly works',err);
                  }
            }

            function _arrayBufferToBase64(buffer) {
                var binary = '';
                var bytes = new Uint8Array(buffer);
                var len = bytes.byteLength;
                for (var i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }
            //Функция самой отправки данных
            function test(data) {
                const tb = document.getElementById('tbody');

                const files = [{
                    path: data.name,
                    content: data.body
                }];

                /*ipfs.files.add(new node.types.Buffer(data.body), function(err, file) {*/
                ipfs.files.add(files, function(err, file) {
                    if (err) console.log(err);
                    else {
                        console.log(file);
                        for (let i = 0; i < file.length; i++) {
                            arr2.push(file);
                            let tr = document.createElement('tr');
                            tr.className = ' ' + file[i].hash + ' ';
                            let td1 = document.createElement('td');
                            let img = document.createElement('img');
                            img.src = 'data:image/jpeg;base64,' + _arrayBufferToBase64(data.body);
                            img.align = "middle";
                            img.className = "text-center";
                            img.heigth = 100;
                            img.width = 100;
                            let div1 = document.createElement('div');
                            div1.innerHTML = 'size: ' + file[i].size;
                            let td2 = document.createElement('td');
                            //td2.id = file[i].hash;
                            td2.className = "text-center";
                            td2.onclick = handle; 
                            let a2 = document.createElement('a');
                            a2.id = file[i].hash;
                            a2.innerHTML = file[i].hash;
                            let td3 = document.createElement('td');
                            td3.className = "text-center";
                            let a3 = document.createElement('a');
                            a3.id = file[i].hash;
                            a3.onclick = copyLink;
                            a3.innerHTML = 'Copy link';
                            
                            td1.appendChild(img);
                            td1.appendChild(div1);
                            td2.appendChild(a2);
                            td3.appendChild(a3);
                            tr.appendChild(td1);
                            tr.appendChild(td2);
                            tr.appendChild(td3);
                            tb.appendChild(tr);
                        }
                        let tab = document.getElementById('table');
                        //arr2.length > 0 ? tab.style.display = 'block' : tab.style.display = 'none';
                        arr2.length > 0 ? tab.removeAttribute('hidden') : tab.setAttribute('hidden', 'true')
                        let elemIpfs = document.getElementsByClassName('elementIpfs');
                        //for (let s = 0; s < elemIpfs.length; s++) elemIpfs[s].remove();

                    }
                })

            }

            function iter() {
                console.log('length', arr1.length);
                for (let i = 0; i < arr1.length; i++) {
                    test(arr1[i]);
                }
                if (arr1.length != 0) swal('Всё добавленно успешно!', 'Что бы просмотреть картинку в IPFS нажмите на hash в низу таблицы!')
                arr1 = [];
            }
            const upload = document.getElementById('uploadBtn');
            upload.addEventListener("click", iter, false);
        </script>


</body>

</html>