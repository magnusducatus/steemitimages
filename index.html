<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta charset="utf-8">

    <script src="https://unpkg.com/ipfs-api@9.0.0/dist/index.js" integrity="sha384-5bXRcW9kyxxnSMbOoHzraqa7Z0PQWIao+cgeg327zit1hz5LZCEbIMx/LWKPReuB" crossorigin="anonymous">
    </script>
    <link href="//cdn.muicss.com/mui-0.9.36/css/mui.min.css" rel="stylesheet" type="text/css" />
    <script src="//cdn.muicss.com/mui-0.9.36/js/mui.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.2.0/min/dropzone.min.js" integrity="sha256-eO9VTVeZLaplH86Iwt8l39+l7GZpLOTsVWYziS5oY0Q=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.2.0/min/dropzone.min.css" integrity="sha256-e47xOkXs1JXFbjjpoRr1/LhVcqSzRmGmPqsrUQeVs+g=" crossorigin="anonymous" />

    <script src="https://wzrd.in/standalone/buffer"></script>
    <script src="https://unpkg.com/sweetalert2@7.12.15/dist/sweetalert2.all.js"></script>

    <script>
        var ipfs = window.IpfsApi({
            host: '127.0.0.1',
            port: '5001',
            protocol: 'http'
        })
    </script>
    <script>
        function handle(e) {
            console.log(e.target.id);
            window.open('https://ipfs.io/ipfs/' + e.target.id);
        }
        //Функция самой отправки данных
        function test(data) {
            const tb = document.getElementById('tbody');

            const files = [{
                path: data.name,
                content: data.body
            }]

            ipfs.files.add(files, function(err, file) {
                if (err) console.log(err);
                else {
                    console.log(file);
                    for (let i = 0; i < file.length; i++) {
                        let tr = document.createElement('tr');
                        tr.className = ' ' + file[i].hash + ' ';
                        let td1 = document.createElement('td');
                        td1.innerHTML = file[i].path;
                        let td2 = document.createElement('td');
                        td2.id = file[i].hash;
                        td2.onclick = handle;
                        td2.innerHTML = file[i].hash;
                        tr.appendChild(td1);
                        tr.appendChild(td2);
                        tb.appendChild(tr);
                    }
                }
            })

        }
    </script>

    <style>
        #uploadDiv {
            display: flex;
            flex-flow: column wrap;
            justify-content: center;
            align-items: stretch;

        }
    </style>

</head>

<body>
    <div id="uploadDiv">
        <button id="uploadBtn" class="mui-btn mui-btn--primary" type="button">Upload to IPFS</button>
    </div>
    <form action='/' class="dropzone" id="my-awesome-dropzone">
    </form>
    <script>
        const inputElement = document.getElementById("test");
        inputElement.addEventListener("change", handleFiles, false);

        function handleFiles() {
            let fileList = this.files;
            console.log(fileList);
            for (let i = 0; i < fileList.length; i++) {
                const reader = new FileReader();
                reader.onload = function(data) {
                    //всё отправляем
                    test(data.target.result);
                };
                reader.readAsArrayBuffer(fileList[i]);
            }
        }
    </script>

    <script>
        let arr1 = [];
        Dropzone.options.myAwesomeDropzone = {
            //accept file mime-type
            acceptedFiles: 'image/jpeg, image/jpg, image/png',
            autoProcessQueue: false,
            init: function() {
                this.on("addedfile", function(file) {

                    //second check for mime-type
                    if (file.type != 'image/jpeg' || file.type != 'image/jpg' || file.type != 'image/png') {

                    } else this.removeFile(file);
                    //entity for send to IPFS

                    //console.log(arr1);
                    let fileList = file;
                    console.log('до получения', arr1.length);
                    const reader = new FileReader();
                    reader.onload = function(data) {
                        const obj = {
                            name: '',
                            body: '',
                            hash: '',
                        };
                        //!!!!!This is for version without buffer
                        /*let base64 = window.btoa(data.target.result);
                        obj.body = base64;*/
                        obj.body = buffer.Buffer(data.target.result);
                        obj.name = fileList.name;
                        arr1.push(obj);
                    };
                    reader.readAsArrayBuffer(fileList);
                    // Create the remove button
                    var removeButton = Dropzone.createElement('<button class="mui-btn mui-btn--raised mui-btn--danger">Remove file</button>');


                    // Capture the Dropzone instance as closure.
                    var _this = this;

                    // Listen to the click event
                    removeButton.addEventListener("click", function(e) {
                        // Make sure the button click doesn't submit the form:
                        e.preventDefault();
                        e.stopPropagation();

                        // Remove the file preview.
                        _this.removeFile(file);
                        for (let i = 0; i < arr1.length; i++) {
                            file.name == arr1[i].name ? arr1.splice(i, 1) : '';
                        }
                        // If you want to the delete the file on the server as well,
                        // you can do the AJAX request here.
                    });

                    // Add the button to the file preview element.
                    file.previewElement.appendChild(removeButton);
                    file.previewElement.setAttribute('class', 'dz-preview dz-processing dz-success dz-complete dz-image-preview');
                    file.previewElement.setAttribute('align', 'center');
                });
            }

        };
    </script>
    <script>
        function iter() {
            console.log('length', arr1.length);
            for (let i = 0; i < arr1.length; i++) {
                console.log('arr1', arr1[i]);
                test(arr1[i]);
            }
            arr1 = [];
            if (arr1.length == 0) swal('Всё добавленно успешно!', 'Что бы просмотреть картинку в IPFS нажмите на hash в низу таблицы!')
        }
        const upload = document.getElementById('uploadBtn');
        upload.addEventListener("click", iter, false);
    </script>
    <table id="table" class="mui-table">
        <thead>
            <tr>
                <th>img</th>
                <th>IPFS multihash</th>
            </tr>
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>

</body>

</html>